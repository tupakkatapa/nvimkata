id = "free_079"
version = "1.0.0"
title = "Data Pipeline Transformation"
topic = "grand"
difficulty = 5
hint = "Rename functions and variables, change data formats, convert loops to comprehensions, restructure error handling, update I/O patterns"

[start]
content = """
import csv
import sys
import time

def step1_load(input_file):
    records = []
    f = open(input_file, "r")
    reader = csv.DictReader(f)
    for row in reader:
        records.append(row)
    f.close()
    print("Loaded " + str(len(records)) + " records")
    return records

def step2_clean(records):
    cleaned = []
    for rec in records:
        try:
            rec["amount"] = float(rec["amount"])
        except:
            print("Bad amount: " + rec.get("id", "?"))
            continue
        if rec["amount"] < 0:
            continue
        rec["name"] = rec["name"].strip().title()
        rec["category"] = rec["category"].strip().lower()
        cleaned.append(rec)
    print("Cleaned " + str(len(cleaned)) + " records")
    return cleaned

def step3_aggregate(records):
    groups = {}
    for rec in records:
        cat = rec["category"]
        if cat not in groups:
            groups[cat] = {"count": 0, "total": 0.0, "items": []}
        groups[cat]["count"] = groups[cat]["count"] + 1
        groups[cat]["total"] = groups[cat]["total"] + rec["amount"]
        groups[cat]["items"].append(rec["name"])
    print("Grouped into " + str(len(groups)) + " categories")
    return groups

def step4_report(groups, output_file):
    f = open(output_file, "w")
    for cat in sorted(groups.keys()):
        g = groups[cat]
        avg = g["total"] / g["count"]
        f.write("Category: " + cat + "\\n")
        f.write("  Count: " + str(g["count"]) + "\\n")
        f.write("  Total: $" + str(round(g["total"], 2)) + "\\n")
        f.write("  Average: $" + str(round(avg, 2)) + "\\n")
    f.close()
    print("Report written to " + output_file)

start = time.time()
data = step1_load(sys.argv[1])
data = step2_clean(data)
groups = step3_aggregate(data)
step4_report(groups, sys.argv[2])
print("Done in " + str(round(time.time() - start, 2)) + "s")
"""

[target]
content = """
import json
import logging
import sys
import time
from collections import defaultdict

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def load_records(input_file):
    with open(input_file, "r") as f:
        records = json.load(f)
    logger.info(f"Loaded {len(records)} records")
    return records

def is_valid(rec):
    try:
        return float(rec.get("amount", "")) >= 0
    except (ValueError, TypeError):
        return False

def normalize(rec):
    return {
        **rec,
        "amount": float(rec["amount"]),
        "name": rec["name"].strip().title(),
        "category": rec["category"].strip().lower(),
    }

def clean_records(records):
    cleaned = [normalize(r) for r in records if is_valid(r)]
    logger.info(f"Cleaned {len(cleaned)} records")
    return cleaned

def aggregate_by_category(records):
    groups = defaultdict(lambda: {"count": 0, "total": 0.0, "items": []})
    for rec in records:
        groups[rec["category"]]["count"] += 1
        groups[rec["category"]]["total"] += rec["amount"]
        groups[rec["category"]]["items"].append(rec["name"])
    logger.info(f"Grouped into {len(groups)} categories")
    return dict(groups)

def write_report(groups, output_file):
    report = [
        {"category": cat, "count": g["count"],
         "total": round(g["total"], 2),
         "average": round(g["total"] / g["count"], 2)}
        for cat, g in sorted(groups.items())
    ]
    with open(output_file, "w") as f:
        json.dump(report, f, indent=2)
    logger.info(f"Report written to {output_file}")

start = time.time()
data = load_records(sys.argv[1])
data = clean_records(data)
groups = aggregate_by_category(data)
write_report(groups, sys.argv[2])
logger.info(f"Done in {round(time.time() - start, 2)}s")
"""
